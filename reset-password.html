<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nouveau mot de passe ‚Äî DarkOrbit Stats Tracker Pro</title>
  <style>
    :root { --bg-primary: #0f172a; --bg-secondary: #1e293b; --accent: #38bdf8; --text-primary: #fff; --text-secondary: #cbd5e1; --success: #22c55e; --danger: #ef4444; --border: #334155; --shadow: rgba(0,0,0,.5); }
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-primary); color: var(--text-primary); margin: 0; padding: 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .auth-container { max-width: 420px; width: 100%; padding: 32px; background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 8px 32px var(--shadow); }
    .auth-header { text-align: center; margin-bottom: 28px; }
    .auth-header h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .auth-header p { color: var(--text-secondary); font-size: 0.9rem; }
    .auth-form .field { margin-bottom: 16px; }
    .auth-form label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: var(--text-secondary); }
    .auth-form input { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 8px; background: #0f172a; color: var(--text-primary); font-size: 1rem; }
    .auth-form input:focus { outline: none; border-color: var(--accent); }
    .auth-error { background: rgba(239,68,68,.15); color: var(--danger); padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 16px; display: none; }
    .auth-error.visible { display: block; }
    .auth-success { background: rgba(34,197,94,.15); color: var(--success); padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; margin-bottom: 16px; display: none; }
    .auth-success.visible { display: block; }
    .auth-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 8px; }
    .auth-btn:hover { opacity: 0.9; }
    .auth-btn:disabled { opacity: 0.6; cursor: wait; }
    .auth-link { display: block; text-align: center; margin-top: 16px; color: var(--accent); font-size: 0.9rem; text-decoration: none; }
    .auth-link:hover { text-decoration: underline; }
    .auth-invalid { text-align: center; padding: 24px; color: var(--text-secondary); }
    .auth-invalid p { margin-bottom: 16px; line-height: 1.6; }
  </style>
</head>
<body>
<div class="auth-container">
  <div class="auth-header">
    <h1>üîê D√©finir un nouveau mot de passe</h1>
    <p>Choisissez un mot de passe s√©curis√© (min. 6 caract√®res)</p>
  </div>
  <div id="authError" class="auth-error"></div>
  <div id="authSuccess" class="auth-success"></div>
  <div id="resetFormWrap">
    <form id="resetPasswordForm">
      <div class="field">
        <label for="newPassword">Nouveau mot de passe</label>
        <input type="password" id="newPassword" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
      </div>
      <div class="field">
        <label for="confirmPassword">Confirmer le mot de passe</label>
        <input type="password" id="confirmPassword" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
      </div>
      <button type="submit" class="auth-btn" id="resetSubmit">Enregistrer le mot de passe</button>
    </form>
  </div>
  <div id="invalidStateWrap" class="auth-invalid" style="display:none;">
    <p>Ce lien est invalide ou a expir√©.</p>
    <p>Demandez une nouvelle r√©initialisation depuis l'application.</p>
    <a href="#" id="backLink" class="auth-link">Fermer</a>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
/* TODO: Remplacer par votre URL GitHub Pages d√©ploy√©e */
var GH_PAGES_BASE = 'https://dragonal59.github.io/darkorbit-tracker-auth/';
/* TODO: Remplacer par vos cl√©s Supabase (anon key uniquement) */
var SUPABASE_URL = 'https://cxqdzipcgpbqmjzjrijg.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4cWR6aXBjZ3BicW1qempyaWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MTAxMzAsImV4cCI6MjA4NjI4NjEzMH0.Y5dOuTXjDbYZOW3VhFuOzrWcffb3RTKWbV6zXvP3l4M';
var PROTOCOL_APP = 'darkorbit-tracker://';

(function() {
  var errorEl = document.getElementById('authError');
  var successEl = document.getElementById('authSuccess');
  var formWrap = document.getElementById('resetFormWrap');
  var invalidWrap = document.getElementById('invalidStateWrap');
  var form = document.getElementById('resetPasswordForm');
  var newPass = document.getElementById('newPassword');
  var confirmPass = document.getElementById('confirmPassword');
  var submitBtn = document.getElementById('resetSubmit');
  var backLink = document.getElementById('backLink');

  function showError(msg) {
    if (errorEl) { errorEl.textContent = msg; errorEl.classList.add('visible'); }
    if (successEl) successEl.classList.remove('visible');
  }
  function showSuccess(msg) {
    if (successEl) { successEl.textContent = msg; successEl.classList.add('visible'); }
    if (errorEl) errorEl.classList.remove('visible');
  }

  function isRecoveryFlow() {
    var hash = window.location.hash || '';
    var params = new URLSearchParams(hash.replace(/^#/, ''));
    return params.get('type') === 'recovery';
  }

  function redirectToApp() {
    window.location.href = PROTOCOL_APP + 'reset-password?success=1';
  }

  if (backLink) backLink.href = PROTOCOL_APP + 'reset-password';

  document.addEventListener('DOMContentLoaded', async function() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_ANON_KEY') {
      showError('Configuration Supabase manquante.');
      return;
    }
    if (!isRecoveryFlow()) {
      formWrap.style.display = 'none';
      invalidWrap.style.display = 'block';
      return;
    }
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      var pass = newPass.value;
      var conf = confirmPass.value;
      if (pass.length < 6) { showError('Le mot de passe doit contenir au moins 6 caract√®res.'); return; }
      if (pass !== conf) { showError('Les deux mots de passe ne correspondent pas.'); return; }
      if (submitBtn) submitBtn.disabled = true;
      var { error } = await supabase.auth.updateUser({ password: pass });
      if (submitBtn) submitBtn.disabled = false;
      if (error) { showError(error.message); return; }
      showSuccess('Mot de passe mis √† jour. Redirection vers l\'application...');
      setTimeout(redirectToApp, 1500);
    });
  });
})();
</script>
</body>
</html>
